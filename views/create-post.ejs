<!DOCTYPE html>
<html>

<head>
  <title>CORE - Create Post</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="shortcut icon" href="img/core.png" />
  <link rel="stylesheet" href="/css/navbar.css" />
  <link rel="stylesheet" href="/css/create-post.css" />
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

</head>

<body>
  <%- include('partials/navbar', { pagePath: 'home' }) %>
  <main>
    <div class="post-header">
      <h2>Create a Post</h2>
    </div>
    <div class="post-selector">
      <div class="post-type">
        <a href="#" class="post-type-button">Post</a>
      </div>
      <div class="post-type">
        <a href="#" class="post-type-button">Project</a>
      </div>
      <div class="post-type">
        <a href="#" class="post-type-button">Blog</a>
      </div>
    </div>
    <div class="main-container">

      <form action="/posts" method="POST">
        <div class="form-group">
          <input type="hidden" name="userId" value="<%= user.id %>" />
          <label for="title">Title:</label>
          <input type="text" id="title" name="title" required />
          <div class="form-group" id="community">
            <label for="community">Community:</label>
            <select id="community_choice" name="community_id">
            </select>
          </div>
          <div class="form-group">
            <label for="link">Link:</label>
            <input type="text" id="link" name="link" />
          </div>
          <div class="form-group">
            <label for="content">Content:</label>
            <textarea id="content" name="content"></textarea>
          </div>

          <div class="form-group">
            <label>Tags:</label>
            <div id="tags-container">
              <select class="tags-select2" name="tags[]" multiple="multiple">
                <% tags.forEach(function(tag) { %>
                <option value="<%= tag.id %>"><%= tag.name %></option>
                <% }); %>
              </select>
            </div>

          </div>
          <button class="add-post-button" type="submit">Submit Post</button>
      </form>
    </div>
  </main>
  <script>
    $(document).ready(function() {
      $('.tags-select2').select2({
        width: '100%' // Full width of its container
      });

      var easyMDE = new EasyMDE({
        element: document.getElementById('content')
      });

      $('form').on('submit', function(e) {
        // Check if the EasyMDE editor is empty
        if (!easyMDE.value().trim()) {
          // Prevent form submission
          e.preventDefault();
          // Display an error message or focus the EasyMDE editor
          alert("Please fill in the content.");
          easyMDE.codemirror.focus();
        } else {
          // Form is valid, submit it
          // Optional: Sync content back to textarea if not automatically done
          easyMDE.toTextArea();
          easyMDE.codemirror.save();
        }
      });
    });

    function getAllCommunities() {
      fetch('/api/communities') // Adjust this to your server's endpoint
        .then(response => response.json())
        .then(communities => {
          // Create an option for each community
          communities.forEach(community => {
            const option = document.createElement('option');
            option.value = community.id;
            option.textContent = community.name;
            document.getElementById('community_choice').appendChild(option);
          });
        });
    }

    getAllCommunities();
  </script>
</body>

</html>