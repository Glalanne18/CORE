<!DOCTYPE html>
<html>
  <head>
    <title>CORE</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="stylesheet" href="/css/post.css" />
  </head>
  <body>
    <%- include('partials/navbar', { pagePath: 'home' }) %>

    <div class="main-container">
      <div class="post">
        <h2 class="post-title"><%= post.title %></h2>
        <a class="user-info" href="/profile/<%= post.user.username %>"
          ><%= post.user.username %></a
        >
        / <% let postDate = new Date(post.created_at); let today = new Date();
        let formattedDate; let timeOptions = { hour: '2-digit', minute:
        '2-digit' }; if(postDate.toDateString() === today.toDateString()) {
        formattedDate = `Today, ${postDate.toLocaleTimeString(undefined,
        timeOptions)}`; } else { formattedDate =
        `${postDate.toLocaleDateString()},
        ${postDate.toLocaleTimeString(undefined, timeOptions)}`; } %> <%=
        formattedDate %>
        <div class="post-content"><%= post.content %></div>
        <% if (user && user.username === post.user.username) { %>
        <form
          action="/post/<%= post.id %>?_method=DELETE"
          method="POST"
          onsubmit="return confirm('Are you sure you want to delete this post?');"
        >
          <input type="hidden" name="_method" value="DELETE" />
          <a
            href="#"
            id="delete-post-button"
            onclick="this.closest('form').submit(); return false;"
          >
            <span class="material-symbols-outlined"> delete </span> Delete Post
          </a>
        </form>
        <% } %>
      </div>

      <div class="comments-section">
        <h3>Comments</h3>

        <!-- Add Comment Form, only if user is logged in -->
        <% if (user) { %>
        <form
          id="comment-form"
          action="/posts/<%= post.id %>/comments"
          method="POST"
        >
          <div class="input-container">
            <input type="text" id="comment" name="comment" required />
            <a href="#" class="fab" onclick="submitForm('comment-form');">
              <span class="material-symbols-outlined">send</span>
            </a>
          </div>
        </form>
        <% } %> <% function renderComments(comments) { %> <%
        comments.forEach(comment => { %>
        <div class="comment">
          <div class="comment-content">
            <a class="user-info" href="/profile/<%= post.user.username %>"
              ><%= comment.user.username%></a
            >
            / <% let commentDate = new Date(comment.created_at); let today = new
            Date(); let formattedDate; let timeOptions = { hour: '2-digit',
            minute: '2-digit' }; if(commentDate.toDateString() ===
            today.toDateString()) { formattedDate = `Today,
            ${commentDate.toLocaleTimeString(undefined, timeOptions)}`; } else {
            formattedDate = `${commentDate.toLocaleDateString()},
            ${commentDate.toLocaleTimeString(undefined, timeOptions)}`; } %> <%=
            formattedDate %>
          </div>
          <%= comment.comment %> <% if (user) { %>
          <form
            action="/comments/<%= comment.id %>/replies"
            method="POST"
            class="reply-form"
            style="display: none"
          >
            <textarea name="comment" required></textarea>
            <button type="submit">Submit Reply</button>
          </form>
          <div class="user-actions">
            <% if (user) { %>
            <a
              href="#"
              id="reply-button"
              onclick="showReplyForm('<%= comment.id %>')"
            >
              <span class="material-symbols-outlined">reply</span> Reply
            </a>
            <% } %> <% if (user && user.username === comment.user.username) { %>
            <form
              id="delete-comment-form-<%= comment.id %>"
              action="/comment/<%= comment.id %>?_method=DELETE"
              method="POST"
              onsubmit="return confirm('Are you sure you want to delete this comment?');"
            >
              <input type="hidden" name="_method" value="DELETE" />
              <a
                href="#"
                class="delete-comment-button-<%= comment.id %>"
                onclick="document.getElementById('delete-comment-form-<%= comment.id %>').submit();"
              >
                <span class="material-symbols-outlined"> delete </span> Delete
                comment
              </a>
            </form>
            <% } %> <% } %>
          </div>
          <form
            id="reply-form-<%= comment.id %>"
            action="/comments/<%= comment.id %>/replies"
            method="POST"
            style="display: none"
          >
            <div class="input-container">
              <textarea
                id="reply-<%= comment.id %>"
                name="comment"
                required
              ></textarea>
              <a
                href="#"
                class="fab"
                onclick="submitForm('reply-form-<%= comment.id %>');"
              >
                <span class="material-symbols-outlined">send</span>
              </a>
            </div>
          </form>

          <!-- Render nested comments -->
          <% if (comment.replies && comment.replies.length > 0) { %>
          <div class="nested-comment">
            <% renderComments(comment.replies); %>
          </div>
          <% } %>
        </div>
        <% }) %> <% } %> <% renderComments(post.comments); %>
      </div>
    </div>

    <script>
      function submitForm(formId) {
        var form = document.getElementById(formId);

        if (!form) {
          console.error("Form not found: " + formId);
          return false;
        }

        var isReplyForm = formId.startsWith("reply-form");

        var inputField;
        if (isReplyForm) {
          inputField = form.querySelector("textarea");
        } else {
          inputField = form.querySelector('input[name="comment"]');
        }

        // Check if the input field or textarea exists
        if (!inputField) {
          console.error("Input field not found in form: " + formId);
          return false;
        }

        // Validate input value
        if (inputField.value.trim() === "") {
          alert("Your message cannot be empty.");
          return false;
        } else {
          // Submit the form
          form.submit();
        }
      }

      function showReplyForm(commentId) {
        var form = document.getElementById("reply-form-" + commentId);
        form.style.display = form.style.display === "none" ? "block" : "none";
      }
    </script>
  </body>
</html>
