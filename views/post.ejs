<!DOCTYPE html>
<html>
  <head>
    <title>CORE</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="stylesheet" href="/css/post.css" />
  </head>
  <body>
    <%- include('partials/navbar', { pagePath: 'home' }) %>

    <div class="main-container">
      <div class="post">
        <h2 class="post-title"><%= post.title %></h2>
        <p class="user-info"><%= post.user.username %></p>
        <div class="post-content"><%= post.content %></div>
        <% if (user && user.username === post.user.username) { %>
        <form
          action="/post/<%= post.id %>?_method=DELETE"
          method="POST"
          onsubmit="return confirm('Are you sure you want to delete this post?');"
        >
          <input type="hidden" name="_method" value="DELETE" />
          <a
            href="#"
            id="delete-post-button"
            onclick="this.closest('form').submit(); return false;"
          >
            <span class="material-symbols-outlined"> delete </span> Delete Post
          </a>
        </form>
        <% } %>
      </div>

      <div class="comments-section">
        <h3>Comments</h3>

        <!-- Add Comment Form, only if user is logged in -->
        <% if (user) { %>
        <form action="/posts/<%= post.id %>/comments" method="POST">
          <textarea name="comment" required></textarea>
          <button type="submit">Submit Comment</button>
        </form>
        <% } %> <% function renderComments(comments) { %> <%
        comments.forEach(comment => { %>
        <div class="comment">
          <div class="comment-content"><%= comment.comment %></div>
          <p class="user-info"><%= comment.user.username%></p>
          <% if (user) { %>
          <form
            action="/comments/<%= comment.id %>/replies"
            method="POST"
            class="reply-form"
            style="display: none"
          >
            <textarea name="comment" required></textarea>
            <button type="submit">Submit Reply</button>
          </form>
          <div class="user-actions">
            <% if (user && user.username === comment.user.username) { %>
            <form
              action="/comment/<%= comment.id %>?_method=DELETE"
              method="POST"
              onsubmit="return confirm('Are you sure you want to delete this comment?');"
            >
              <input type="hidden" name="_method" value="DELETE" />
              <button type="submit">Delete Comment</button>
            </form>
            <button onclick="showReplyForm('<%= comment.id %>')">Reply</button>

            <% } %> <% } %>
          </div>
          <form
          id="reply-form-<%= comment.id %>"
          action="/comments/<%= comment.id %>/replies"
          method="POST"
          class="reply-form"
          style="display: none"
        >
          <textarea name="comment" required></textarea>
          <button type="submit">Submit Reply</button>

          <!-- Render nested comments -->
          <% if (comment.replies && comment.replies.length > 0) { %>
          <div class="nested-comment">
            <% renderComments(comment.replies); %>
          </div>
          <% } %>
        </div>
        <% }) %> <% } %> <% renderComments(post.comments); %>
      </div>
    </div>

    <script>
function showReplyForm(commentId) {
  var form = document.getElementById('reply-form-' + commentId);
  form.style.display = form.style.display === "none" ? "block" : "none";
}

    </script>
  </body>
</html>
