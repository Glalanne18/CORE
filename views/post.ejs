<!DOCTYPE html>
<html>
  <head>
    <title>CORE</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="stylesheet" href="/css/navbar.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f4f4f4;
      }

      .main-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0px 0px 20px 0px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }

      .post,
      .comment {
        padding: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid #eaeaea;
      }
      .nested-comment {
        margin-left: 40px;
        border-left: 2px solid #eaeaea;
        padding-left: 20px;
      }

      .post-title {
        font-size: 24px;
        color: #333;
        margin-bottom: 10px;
      }

      .user-info {
        font-size: 14px;
        color: #888;
        margin-bottom: 20px;
      }

      .post-content,
      .comment-content {
        font-size: 16px;
        line-height: 1.6;
        color: #666;
      }

      .comments-section {
        margin-top: 40px;
      }

      .comments-section h3 {
        font-size: 20px;
        color: #333;
        margin-bottom: 20px;
      }

      .comment {
        margin-left: 20px;
      }

      .user-actions {
        display: flex;
        align-items: center;
      }

      .user-actions button {
        margin-right: 10px;
      }

      .user-actions button:not(:last-child) {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <%- include('partials/navbar', { pagePath: 'home' }) %>

    <div class="main-container">
      <div class="post">
        <h2 class="post-title"><%= post.title %></h2>
        <p class="user-info"><%= post.user.username %></p>
        <div class="post-content"><%= post.content %></div>
        <% if (user && user.username === post.user.username) { %>
        <form
          action="/post/<%= post.id %>?_method=DELETE"
          method="POST"
          onsubmit="return confirm('Are you sure you want to delete this post?');"
        >
          <input type="hidden" name="_method" value="DELETE" />
          <button type="submit">Delete Post</button>
        </form>
        <% } %>
      </div>

      <div class="comments-section">
        <h3>Comments</h3>

        <!-- Add Comment Form, only if user is logged in -->
        <% if (user) { %>
        <form action="/posts/<%= post.id %>/comments" method="POST">
          <textarea name="comment" required></textarea>
          <button type="submit">Submit Comment</button>
        </form>
        <% } %> <% function renderComments(comments) { %> <%
        comments.forEach(comment => { %>
        <div class="comment">
          <div class="comment-content"><%= comment.comment %></div>
          <p class="user-info"><%= comment.user.username%></p>
          <% if (user) { %>
          <form
            action="/comments/<%= comment.id %>/replies"
            method="POST"
            class="reply-form"
            style="display: none"
          >
            <textarea name="comment" required></textarea>
            <button type="submit">Submit Reply</button>
          </form>
          <div class="user-actions">
            <% if (user && user.username === comment.user.username) { %>
            <form
              action="/comment/<%= comment.id %>?_method=DELETE"
              method="POST"
              onsubmit="return confirm('Are you sure you want to delete this comment?');"
            >
              <input type="hidden" name="_method" value="DELETE" />
              <button type="submit">Delete Comment</button>
            </form>
            <% } %>
            <button onclick="showReplyForm(this)">Reply</button>
            <% } %>
          </div>

          <!-- Render nested comments -->
          <% if (comment.replies && comment.replies.length > 0) { %>
          <div class="nested-comment">
            <% renderComments(comment.replies); %>
          </div>
          <% } %>
        </div>
        <% }) %> <% } %> <% renderComments(post.comments); %>
      </div>
    </div>

    <script>
      // JavaScript function to show reply form
      function showReplyForm(button) {
        const form = button.previousElementSibling;
        form.style.display = form.style.display === "none" ? "block" : "none";
      }
    </script>
  </body>
</html>
